const express = require('express');
const router  = express.Router();
const passport = require('passport');
const Comment = require('../../lib/db').Comment;
const ensureLoggedIn = require('connect-ensure-login').ensureLoggedIn.bind(null, '/api/v1/users/login');

router.get('/login', (req, res) => {
    res.json({err: true, message: "You are not logged in"});
});

router.post('/login',
    passport.authenticate('json', { failureRedirect: '/api/v1/users/login' }),
    (req, res) => {
        res.json({err: false, message: "Logged in"});
    });

router.get('/logout', ensureLoggedIn(), (req, res) => {
    req.logout();
    res.redirect('/api/v1/users/login');
});

router.get('/profile', ensureLoggedIn(), (req, res) => {
        res.json(req.user);
    });

router.get('/comments', ensureLoggedIn(), (req, res) => {
    Comment.findAll({where: {UserId: req.user.id}}).then(comments => {
        res.json(comments);
    }).catch(err => {
        console.error(err);
        res.json({err: true, message: err.message});
    });
});

router.post('/signup', passport.authenticate('signup', {
    successRedirect: '/api/v1/users/profile',
    failureRedirect: '/api/v1/users/login'
}));

module.exports = router;
