var express    = require('express');        // call express
var app        = express();                 // define our app using express
var fs         = require('fs');
var model      = require('./model.js');
var path       = require('path');
var mime       = require('mime');

var port = process.env.PORT || 8080;        // set our port

var router = express.Router();              // get an instance of the express Router

// router.get('/', function(req, res) {
//    res.send("test");
// });

function parseParameters(req, callback) {
    options = {}
    if (req.query.author != undefined) {
        options['author'] = req.query.author;
    }
    if (req.query.platform != undefined) {
        options['platform'] = req.query.platform;
    }
    if (req.query.port != undefined) {
        options['port'] = req.query.port;
    }
    if (req.query.description != undefined) {
        options['description'] = req.query.description;
    }
    if (req.query.type != undefined) {
        options['type'] = req.query.type;
    }
    if (req.query.before != undefined) {
        options['before'] = req.query.before;
    }
    if (req.query.after != undefined) {
        options['after'] = req.query.after;
    }
    if (req.query.take != undefined) {
        options['take'] = req.query.take;
    }
    if (req.query.skip != undefined) {
        options['skip'] = req.query.skip;
    }
    callback(options);
}

// retrieves all exploit
router.get('/exploits', function (req, res) {
    res.setHeader('Content-Type', 'application/json');

    parseParameters(req, function (options) {
        model.getExploits(undefined, options, function (results){
            res.status((results.length > 0) ? 200 : 404).end(JSON.stringify(results));
        });
    });
});

// retrieves a specific exploit
router.get('/exploits/:id', function (req, res) {
    res.setHeader('Content-Type', 'application/json');
    model.getExploits(req.params.id, undefined, function (results){
        res.status((results.length > 0) ? 200 : 404).end(JSON.stringify(results));
    });
});

// retrieves the attachment of an exploit
router.get('/exploits/:id/attachment', function (req, res) {
    model.getExploits(req.params.id, undefined, function (results){
        if (results[0] && results[0]['file']) {
            var file = __dirname + '/exploitdb/' + results[0]['file'];

            var filename = path.basename(file);
            var mimetype = mime.lookup(file);

            res.setHeader('Content-disposition', 'attachment; filename=' + filename);
            res.setHeader('Content-type', mimetype);

            var filestream = fs.createReadStream(file);
            filestream.pipe(res);
        } else {
            res.status(404).end();
        }
    });
});

// manages 404
router.get('*', function(req, res){
    res.redirect('/exploits');
});

app.use('/', router);
app.listen(port);
console.log("Open browser at: http://127.0.0.1:" + port);
